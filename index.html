<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Mobile Chess Game</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      background: #e0e0e0;
      font-family: 'Roboto', sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      min-height: 100vh;
      touch-action: manipulation;
      overflow-x: hidden;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    #status {
      margin: 1rem 0;
      font-size: 4vmin;
      font-weight: 700;
      color: #333;
      text-align: center;
      width: 100%;
    }

    #board-container {
      width: 90vmin;
      max-width: 500px;
      height: 90vmin;
      max-height: 500px;
      margin: 0 auto;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: transform 0.5s ease;
    }

    #board-container.flipped {
      transform: rotate(180deg);
    }

    #board-container.flipped .square,
    #board-container.flipped .piece,
    #board-container.flipped .label {
      transform: rotate(180deg);
    }

    #chessboard {
      width: 100%;
      height: 100%;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      grid-template-rows: repeat(8, 1fr);
      aspect-ratio: 1 / 1;
      border: 3px solid #333;
      background: #fff;
    }

    .square {
      position: relative;
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 5.5vmin;
      user-select: none;
      cursor: pointer;
    }

    .light { background-color: #f4e3c9; }
    .dark { background-color: #8b5a2b; }

    .piece {
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      position: relative;
      z-index: 2;
      font-size: 5.5vmin;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
      transition: transform 0.2s ease;
    }

    .piece.moving {
      transform: translate(0, -10%) scale(1.1);
    }

    .selected { background-color: rgba(255, 255, 0, 0.5); }
    .highlight { background-color: rgba(0, 255, 0, 0.3); }
    .in-check { background-color: rgba(255, 0, 0, 0.5); }
    .last-move { background-color: rgba(255, 165, 0, 0.4); }

    #promotionPopup, #gameModeModal, #gameOverModal {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 2px solid #333;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
      z-index: 1000;
      text-align: center;
      width: 80vmin;
      max-width: 400px;
    }

    #promotionPopup p, #gameModeModal p, #gameOverModal p {
      font-size: 3.5vmin;
      margin: 0 0 15px;
    }

    #promotionPopup button, #gameModeModal button, #gameOverModal button {
      font-size: 3vmin;
      padding: 10px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      background: #4a4a4a;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    #promotionPopup button:hover, #gameModeModal button:hover, #gameOverModal button:hover {
      background: #5a5a5a;
    }

    .label {
      position: absolute;
      font-size: 2.5vmin;
      color: #333;
      user-select: none;
      font-weight: 500;
    }

    .rank-label {
      left: -3.5vmin;
      text-align: right;
      width: 3vmin;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
    }

    .file-label {
      bottom: -3.5vmin;
      text-align: center;
      width: 100%;
      height: 3vmin;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #moveHistory {
      margin: 1rem 0;
      max-height: 20vh;
      overflow-y: auto;
      width: 90vmin;
      max-width: 500px;
      border: 1px solid #ccc;
      border-radius: 5px;
      padding: 10px;
      font-size: 2.5vmin;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    #moveHistory div {
      padding: 2px 0;
    }

    #controls, #gameOptions, #fenControl {
      margin: 1rem 0;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 10px;
      width: 90vmin;
      max-width: 500px;
      justify-content: center;
    }

    #controls button, #gameOptions button, #fenControl button {
      padding: 10px;
      font-size: 3vmin;
      font-weight: 500;
      border: none;
      border-radius: 5px;
      background: #4a4a4a;
      color: #fff;
      cursor: pointer;
      transition: background 0.2s;
    }

    #controls button:hover, #gameOptions button:hover, #fenControl button:hover {
      background: #5a5a5a;
    }

    #fenInput {
      padding: 10px;
      font-size: 3vmin;
      border-radius: 5px;
      border: 1px solid #ccc;
    }

    #volumeControl, #soundToggle, #contrastToggle, #debugToggle {
      position: fixed;
      bottom: 10px;
      right: 10px;
      padding: 10px;
      background: #4a4a4a;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      z-index: 1000;
      font-size: 3vmin;
    }

    #volumeControl {
      bottom: 60px;
      display: flex;
      align-items: center;
      gap: 5px;
    }

    #volumeSlider {
      width: 100px;
    }

    #soundToggle:hover, #contrastToggle:hover, #debugToggle:hover {
      background: #5a5a5a;
    }

    .error-message {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #ff4444;
      color: white;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 1001;
      display: none;
    }

    .high-contrast .light { background-color: #fff; }
    .high-contrast .dark { background-color: #333; }
    .high-contrast .piece { color: #fff; text-shadow: 0 0 2px #000; }
    .high-contrast .selected { background-color: #ff0; }
    .high-contrast .highlight { background-color: #0f0; }
    .high-contrast .in-check { background-color: #f00; }
    .high-contrast .last-move { background-color: #ffa500; }

    @media screen and (max-width: 400px) {
      #board-container {
        width: 95vmin;
        height: 95vmin;
      }
      .piece {
        font-size: 5vmin;
      }
      .label {
        font-size: 2vmin;
      }
    }
  </style>
</head>
<body>
  <div id="status" aria-live="polite">White's turn</div>
  <div id="board-container">
    <div id="chessboard" role="grid" aria-label="Chess board"></div>
  </div>

  <div id="moveHistory"></div>

  <div id="controls">
    <button id="newGameBtn">New Game</button>
    <button id="undoBtn">Undo</button>
    <button id="flipBoardBtn">Flip Board</button>
    <button id="exportPgnBtn">Export PGN</button>
  </div>

  <div id="gameOptions">
    <button id="offerDrawBtn">Offer Draw</button>
    <button id="resignBtn">Resign</button>
  </div>

  <div id="fenControl">
    <input type="text" id="fenInput" placeholder="Enter FEN">
    <button id="loadFenBtn">Load FEN</button>
  </div>

  <div id="promotionPopup">
    <p>Choose promotion:</p>
    <div>
      <button data-piece="Q">♕</button>
      <button data-piece="R">♖</button>
      <button data-piece="B">♗</button>
      <button data-piece="N">♘</button>
    </div>
  </div>

  <div id="gameModeModal">
    <p>Choose Game Mode:</p>
    <button id="playBotBtn">Play vs Bot</button>
    <button id="playTwoPlayerBtn">Two Players</button>
    <div id="botOptions" style="display: none; margin-top: 15px;">
      <p>Play as:</p>
      <button id="playAsWhiteBtn">White</button>
      <button id="playAsBlackBtn">Black</button>
      <p>Difficulty:</p>
      <select id="botDifficulty">
        <option value="1">Beginner</option>
        <option value="3" selected>Intermediate</option>
        <option value="5">Advanced</option>
      </select>
    </div>
  </div>

  <div id="gameOverModal">
    <p id="gameOverMessage"></p>
    <button id="newGameAfterEndBtn">New Game</button>
    <button id="exportPgnAfterEndBtn">Export PGN</button>
  </div>

  <button id="contrastToggle">High Contrast</button>
  <div id="volumeControl">
    <label for="volumeSlider">Volume:</label>
    <input type="range" id="volumeSlider" min="0" max="1" step="0.1" value="0.3">
  </div>
  <button id="soundToggle">🔊 Sound On</button>
  <button id="debugToggle">Debug Off</button>

  <div class="error-message" id="errorMessage"></div>

  <script>
    // Error handling wrapper
    function safeExecute(fn, errorMessage = 'An error occurred') {
      try {
        return fn();
      } catch (error) {
        console.error(errorMessage, error);
        showError(errorMessage);
        return null;
      }
    }

    function showError(message) {
      const errorEl = document.getElementById('errorMessage');
      if (errorEl) {
        errorEl.textContent = message;
        errorEl.style.display = 'block';
        setTimeout(() => {
          errorEl.style.display = 'none';
        }, 3000);
      }
    }

    // DOM elements
    const board = document.getElementById('chessboard');
    const status = document.getElementById('status');
    const moveHistoryEl = document.getElementById('moveHistory');
    const newGameBtn = document.getElementById('newGameBtn');
    const undoBtn = document.getElementById('undoBtn');
    const flipBoardBtn = document.getElementById('flipBoardBtn');
    const exportPgnBtn = document.getElementById('exportPgnBtn');
    const offerDrawBtn = document.getElementById('offerDrawBtn');
    const resignBtn = document.getElementById('resignBtn');
    const playBotBtn = document.getElementById('playBotBtn');
    const playTwoPlayerBtn = document.getElementById('playTwoPlayerBtn');
    const playAsWhiteBtn = document.getElementById('playAsWhiteBtn');
    const playAsBlackBtn = document.getElementById('playAsBlackBtn');
    const loadFenBtn = document.getElementById('loadFenBtn');
    const soundToggle = document.getElementById('soundToggle');
    const volumeSlider = document.getElementById('volumeSlider');
    const contrastToggle = document.getElementById('contrastToggle');
    const debugToggle = document.getElementById('debugToggle');
    const gameModeModal = document.getElementById('gameModeModal');
    const botOptions = document.getElementById('botOptions');
    const gameOverModal = document.getElementById('gameOverModal');

    // Sound system with fallback audio
    const sounds = {};
    let soundEnabled = true;
    let audioInitialized = false;
    let currentVolume = 0.3;

    // Game state
    let gameBoard = [];
    let selectedPiece = null;
    let selectedSquare = null;
    let currentPlayer = 'white';
    let pendingPromotion = null;
    let enPassantTarget = null;
    let moveCount = 0;
    let gameOver = false;
    let moveHistory = [];
    let boardHistory = [];
    let lastMove = null;
    let playerSide = 'white';
    let gameMode = 'bot';
    let isBoardFlipped = false;
    let moveCache = new Map();
    let transpositionTable = new Map();
    let botDepth = 3;
    let debugMode = false;
    let touchStartTime = 0;
    let touchStartPos = { x: 0, y: 0 };
    let isDragging = false;
    const CACHE_LIMIT = 500;
    const TOUCH_THRESHOLD = 10;

    const castlingRights = {
      white: { K: true, Q: true },
      black: { K: true, Q: true }
    };

    const initialPosition = [
      ['r', 'n', 'b', 'q', 'k', 'b', 'n', 'r'],
      ['p', 'p', 'p', 'p', 'p', 'p', 'p', 'p'],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['', '', '', '', '', '', '', ''],
      ['P', 'P', 'P', 'P', 'P', 'P', 'P', 'P'],
      ['R', 'N', 'B', 'Q', 'K', 'B', 'N', 'R']
    ];

    const pieceSymbols = {
      'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔',
      'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚'
    };

    // Audio system with synthetic sound generation
    function createSyntheticSound(frequency, duration, type = 'sine') {
      return safeExecute(() => {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.value = frequency;
        oscillator.type = type;
        
        gainNode.gain.setValueAtTime(currentVolume, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
        
        return true;
      }, 'Failed to create synthetic sound') || false;
    }

    function initializeAudio() {
      if (audioInitialized) return;
      
      safeExecute(() => {
        // Create synthetic sounds if audio files not available
        sounds.move = () => createSyntheticSound(440, 0.1);
        sounds.capture = () => createSyntheticSound(330, 0.15);
        sounds.check = () => createSyntheticSound(660, 0.2);
        sounds.checkmate = () => createSyntheticSound(220, 0.5);
        sounds.castle = () => createSyntheticSound(550, 0.1);
        sounds.promotion = () => createSyntheticSound(880, 0.2);
        sounds.invalid = () => createSyntheticSound(150, 0.3, 'square');
        
        audioInitialized = true;
      }, 'Failed to initialize audio');
    }

    function enableAudio() {
      if (!audioInitialized) {
        initializeAudio();
        document.removeEventListener('click', enableAudio);
        document.removeEventListener('touchend', enableAudio);
      }
    }

    document.addEventListener('click', enableAudio);
    document.addEventListener('touchend', enableAudio, { passive: true });

    function playSound(soundName) {
      if (soundEnabled && audioInitialized && sounds[soundName]) {
        safeExecute(() => {
          sounds[soundName]();
        }, `Failed to play ${soundName} sound`);
      }
    }

    // Sound controls
    soundToggle.addEventListener('click', () => {
      soundEnabled = !soundEnabled;
      soundToggle.textContent = soundEnabled ? "🔊 Sound On" : "🔇 Sound Off";
    });

    volumeSlider.addEventListener('input', (e) => {
      currentVolume = parseFloat(e.target.value);
    });

    // Contrast toggle
    contrastToggle.addEventListener('click', () => {
      document.body.classList.toggle('high-contrast');
      contrastToggle.textContent = document.body.classList.contains('high-contrast') ? 
        'Normal Contrast' : 'High Contrast';
    });

    // Debug toggle
    debugToggle.addEventListener('click', () => {
      debugMode = !debugMode;
      debugToggle.textContent = debugMode ? 'Debug On' : 'Debug Off';
    });

    // Cache management
    function addToMoveCache(key, value) {
      safeExecute(() => {
        if (moveCache.size >= CACHE_LIMIT) {
          const firstKey = moveCache.keys().next().value;
          moveCache.delete(firstKey);
        }
        moveCache.set(key, value);
      }, 'Cache management failed');
    }

    function clearCaches() {
      moveCache.clear();
      transpositionTable.clear();
    }

    // Board initialization and rendering
    function initializeBoard() {
      safeExecute(() => {
        if (!gameBoard.length) {
          gameBoard = initialPosition.map(row => row.slice());
          saveBoardState();
        }
        renderBoard();
        initializeAudio();
      }, "Failed to initialize board");
    }

    function renderBoard() {
      safeExecute(() => {
        if (!board) return;
        
        board.innerHTML = '';
        
        for (let row = 0; row < 8; row++) {
          for (let col = 0; col < 8; col++) {
            const square = document.createElement('div');
            square.classList.add('square', (row + col) % 2 === 0 ? 'light' : 'dark');
            square.dataset.row = row;
            square.dataset.col = col;
            
            // Accessibility
            const notation = String.fromCharCode(97 + col) + (8 - row);
            const piece = gameBoard[row][col];
            square.setAttribute('aria-label', `Square ${notation}${piece ? ` containing ${pieceSymbols[piece]}` : ''}`);
            square.setAttribute('tabindex', '0');
            square.setAttribute('role', 'gridcell');

            // Coordinate labels
            if (col === 0) {
              const rankLabel = document.createElement('div');
              rankLabel.classList.add('label', 'rank-label');
              rankLabel.textContent = 8 - row;
              square.appendChild(rankLabel);
            }
            if (row === 7) {
              const fileLabel = document.createElement('div');
              fileLabel.classList.add('label', 'file-label');
              fileLabel.textContent = String.fromCharCode(97 + col);
              square.appendChild(fileLabel);
            }

            // Highlight last move
            if (lastMove && 
                ((row === lastMove.from[0] && col === lastMove.from[1]) || 
                 (row === lastMove.to[0] && col === lastMove.to[1]))) {
              square.classList.add('last-move');
            }

            // Add piece
            if (piece) {
              const pieceEl = document.createElement('div');
              pieceEl.classList.add('piece');
              pieceEl.textContent = pieceSymbols[piece];
              pieceEl.dataset.piece = piece;
              square.appendChild(pieceEl);
            }

            // Event listeners
            addSquareEventListeners(square);
            board.appendChild(square);
          }
        }

        updateGameStatus();
      }, "Failed to render board");
    }

    function addSquareEventListeners(square) {
      // Mouse events
      square.addEventListener('click', handleSquareClick);
      
      // Touch events
      square.addEventListener('touchstart', handleTouchStart, { passive: false });
      square.addEventListener('touchmove', handleTouchMove, { passive: false });
      square.addEventListener('touchend', handleTouchEnd, { passive: false });
      
      // Keyboard events
      square.addEventListener('keydown', handleKeyDown);
    }

    // Touch event handlers
    function handleTouchStart(e) {
      if (gameOver) return;
      
      e.preventDefault();
      touchStartTime = Date.now();
      const touch = e.touches[0];
      touchStartPos = { x: touch.clientX, y: touch.clientY };
      isDragging = false;
      
      enableAudio();
    }

    function handleTouchMove(e) {
      if (gameOver) return;
      
      e.preventDefault();
      const touch = e.touches[0];
      const distance = Math.sqrt(
        Math.pow(touch.clientX - touchStartPos.x, 2) +
        Math.pow(touch.clientY - touchStartPos.y, 2)
      );
      
      if (distance > TOUCH_THRESHOLD) {
        isDragging = true;
      }
    }

    function handleTouchEnd(e) {
      if (gameOver) return;
      
      e.preventDefault();
      const touchDuration = Date.now() - touchStartTime;
      
      if (!isDragging || touchDuration < 200) {
        const square = e.currentTarget;
        handleSquareClick({ currentTarget: square });
      }
      
      isDragging = false;
    }

    function handleSquareClick(e) {
      if (gameOver || pendingPromotion) return;
      
      safeExecute(() => {
        const square = e.currentTarget;
        const row = parseInt(square.dataset.row);
        const col = parseInt(squar
